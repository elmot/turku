<!DOCTYPE html>
<html lang='en'>
<!--TODO responsive-->
<!--TODO data retrieving element-->
<!--TODO details-->
<!--TODO Clean up the code -->
<!--TODO2 filtering-->
<!--TODO2 season/open hours on map-->
<head>
    <meta charset='UTF-8'>
    <link rel="icon" sizes="16x16" href="Flag_of_turku_Finland.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turku SightSeeings</title>
    <link type='text/css' rel='stylesheet' href='css/loading.css'/>
    <link type='text/css' rel='stylesheet' href='css/styles.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/Vaadin-Icons.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/map-icons.min.css'/>
    <!-- Import Web Components from bower -->
    <script src='bower_components/webcomponentsjs/webcomponents-lite.min.js'></script>
    <link href='bower_components/vaadin-grid/vaadin-grid.html' rel='import'>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuK9aCv-ALTlzbq1tdnfvmCA76D7VEybc" type="application/javascript"></script>


    <script onerror='alert(this)'>
        var map;
        var markers = {};
        var infoWindow = new google.maps.InfoWindow({content: "test"});
        var typeIcons = {
            "activity park": "icons/playground.png",
            "adventure park": "icons/festival.png",
            "castle": "icons/castle-2.png",
            "church": "icons/church-2.png",
            "museum": "icons/museum_archeological.png",
            "nature": "icons/flowers.png",
            "nature park": "icons/hare1.png",
            "ship cruise": "icons/cruiseship.png",
            "spa": "icons/spa.png",
            "trails": "icons/forest.png",
            "trail": "icons/hiking.png",
            "trip": "icons/map.png",
            "water park": "icons/waterpark.png"
        };
        function initSpreadSheet(gridQuerySelector, worksheetId, sheetId) {
            var sheetUrl = 'https://spreadsheets.google.com/feeds/cells/' + worksheetId + '/' + sheetId
                    + '/public/basic?alt=json-in-script';

            return function () {
                document.body.className = 'wait loading-data';
                var script = document.createElement('script');
                //noinspection JSUnusedLocalSymbols
                script.onerror = function (event) {
                    document.body.className = 'error'
                };
                document.head.appendChild(script);
                gdata = {
                    io: {
                        handleScriptLoaded: function (json) {
                            var arrayData = gdata.data = [];
                            for (var cellIdx = 0; cellIdx < json.feed.entry.length; cellIdx++) {
                                var cell = json.feed.entry[cellIdx];
                                var coords = /\/R(\d+)C(\d+)$/.exec(cell.id.$t);
                                var row = parseInt(coords[1]) - 1;
                                var column = parseInt(coords[2]) - 1;
                                if (arrayData[row] == null) arrayData[row] = [];
                                arrayData[row][column] = cell.content.$t
                            }
                            var data = [];
                            for (var i = 1; i < arrayData.length; i++) {
                                var oldRow = arrayData[i];
                                var newRow = {"id": "place" + i};
                                for (var j = 0; j < oldRow.length; j++)
                                    newRow[arrayData[0][j]] = arrayData[i][j];
                                data.push(newRow)
                            }

                            var renderers = {
                                "Duration": function (cell) {
                                    var cellText = cell.data;
                                    var dist = cell.row.data.Distance;
                                    if (dist != '0' && !isNaN(parseInt(dist)))
                                        cellText += ' (' + dist + 'km)';
                                    cell.element.innerHTML = cellText
                                }

                            };
                            var grid = document.querySelector(gridQuerySelector);
                            grid.columns.filter(function (col) {
                                var renderer = renderers[col.name];
                                if (renderer != null) col.renderer = renderer;
                            });

                            grid.items = data;
                            grid.addEventListener("selected-items-changed", function (e) {
                                for (var markerId in markers) {
                                    markers[markerId].setMap(null);
                                }
                                grid.selection.selected().filter(function (e) {
                                    var marker = markers[grid.items[e].id];
                                    if (marker != null) marker.setMap(map)
                                });
                            });
                            grid.addEventListener('sort-order-changed', function () {
                                var colName1 = grid.columns[grid.sortOrder[0].column].name;
                                var colName2;
                                var lesser2;
                                if (grid.sortOrder[1]) {
                                    colName2 = grid.columns[grid.sortOrder[1].column].name;
                                    lesser2 = grid.sortOrder[1].direction == 'asc' ? -1 : 1;
                                }
                                var lesser1 = grid.sortOrder[0].direction == 'asc' ? -1 : 1;
                                data.sort(function (a, b) {
                                    if (a[colName1] == b[colName1] && colName2 != null) {
                                        return (a[colName2] < b[colName2]) ? lesser2 : -lesser2;
                                    }
                                    return (a[colName1] < b[colName1]) ? lesser1 : -lesser1;
                                });
                            });
                            initPage(grid);
                            grid.selection.selectAll();
                        }
                    }

                };
                script.src = sheetUrl
            }
        }

        function initPage(grid) {
            document.body.className = '';
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 60.18, lng: 21.99},
                zoom: 9
            });

            for (var i = 0; i < grid.items.length; i++) {
                var item = grid.items[i];
                var markerData = /@(-?\d+\.\d*),(-?\d+\.\d*)/.exec(item.Map);
                if (markerData == null) {
                    markerData = [0, 60.18, 21.99];
                    console.log("Unparceable map link: " + item.Map)
                }

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(markerData[1], markerData[2]),
                    title: item.Name,
                    icon: typeIcons[("" + item.Type).toLowerCase()],
                    data: item,
                    map: map
                });
                marker.addListener("click", function (e) {
                    infoWindow.open(map, this);
                });
                markers[item.id] = marker;
            }
            navigator.geolocation.getCurrentPosition(function (position) {
                new google.maps.Marker({
                    position: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                    title: "You",
                    icon: "icons/start-race-2.png",
                    map: map
                });

            });
        }
        HTMLImports.whenReady(initSpreadSheet('vaadin-grid', '1JweHWyLI30MkZiGh1xpzDPynE9zehxQ3tuhZukCFzZE', 'od6'))


    </script>
    <dom-module id="place-details">

        <template>
            <div id="row-details-root">
                <p>
                    <span class="details-type" id="Type">{{place.Type}}</span>:
                    <span id="Description"></span>
                    <a id="url" target="_blank" class="vaadin-icon">&#xe725;</a>
                </p>

                <p>Good for kids: {{}}</p>

                <p>Open: <span id="Open"></span></p>

                <p>Duration: <span id="Duration"></span></p>

                <p>Distance, km: <span id="Distance"></span></p>

                <p>Season: <span id="Season"></span></p>

                <p>Fee: <span id="Fee"></span></p>

                <p>Transport: <span id="Transport"></span></p>
            </div>
        </template>
    </dom-module>

</head>

<body class="wait loading-elements">
<div class="page-header">Turku Sightseeings</div>
<div class="page-content">

    <div id="map"></div>
    <vaadin-grid selection-mode="multi" id="grid">
        <table>
            <!-- Define the columns -->
            <col name="Name" header-text="Name" sortable="">
            <col name="Type" header-text="Description & Map" sortable="">
            <col name="Duration" header-text="Expected duration(Distance)">
        </table>
    </vaadin-grid>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang='en'>
<!--TODO paper tooltip-->
<!--TODO sorting-->
<!--TODO data retrieving element-->
<head>
    <meta charset='UTF-8'>
    <link rel="icon" sizes="16x16" href="Flag_of_turku_Finland.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turku SightSeeings</title>
    <link type='text/css' rel='stylesheet' href='css/loading.css'/>
    <link type='text/css' rel='stylesheet' href='css/styles.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/Vaadin-Icons.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/map-icons.min.css'/>
    <!-- Import Web Components from bower -->
    <script src='bower_components/webcomponentsjs/webcomponents-lite.min.js'></script>
    <link href='bower_components/vaadin-grid/vaadin-grid.html' rel='import'>
    <link href='bower_components/iron-collapse/iron-collapse.html' rel='import'>
    <link href='bower_components/google-map/google-map.html' rel='import'>
    <link href='bower_components/google-map/google-map-marker.html' rel='import'>
    <link href='bower_components/google-map/google-map-directions.html' rel='import'>


    <script onerror='alert(this)'>

        var rendererUtils = {
            vaadinTypeIcon: function (charCode, tooltip, additionalClasses) {
                if (additionalClasses == null)  additionalClasses = '';
                return '<span class="vaadin-icon icon ' + additionalClasses + '" title="' + tooltip + '">&#x' + charCode + ';</span>';
            },
            mapTypeIcon: function (mapClass, tooltip, additionalClasses) {
                if (additionalClasses == null)  additionalClasses = '';
                return '<span class="icon map-icon ' + mapClass + ' ' + additionalClasses + '" title="' + tooltip + '" onclick="showTooltip(this)"></span>';
            },
            renderTransport: function (transport) {
                if (transport == null) return '';
                transport = transport.toUpperCase().split(',');
                var html = '';
                for (var j = 0; j < transport.length; j++) {
                    if (j > 0) html += ' , ';
                    var k = transport[j];
                    var routeLengthCss = '';
                    var routeLengthPrefix = '';
                    if (k.indexOf('LL') >= 0) {
                        routeLengthPrefix = 'Very Long, ';
                        routeLengthCss = 'transport-long-long';
                    } else if (k.indexOf('L') >= 0) {
                        routeLengthPrefix = 'Long, ';
                        routeLengthCss = 'transport-long';
                    }
                    var trHtml = '';
                    if (k.indexOf('B') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-bicycling', routeLengthPrefix + 'Bike');
                    }
                    if (k.indexOf('C') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-taxi-stand', routeLengthPrefix + 'Car');
                    }
                    if (k.indexOf('W') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-walking', routeLengthPrefix + 'Walk');
                    }
                    if (k.indexOf('Y') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-sailing', routeLengthPrefix + 'Yacht');
                    }
                    if (k.indexOf('S') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-boat-tour', routeLengthPrefix + 'Ship');
                    }
                    if (k.indexOf('F') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-boat-tour', routeLengthPrefix + 'Ferry');
                    }
                    if (routeLengthCss != '')
                        trHtml = '<span class="' + routeLengthCss + '">' + trHtml + '</span>';
                    html += trHtml;
                }
                return html;
            }
        };
        function initSpreadSheet(gridQuerySelector, worksheetId, sheetId) {
            var sheetUrl = 'https://spreadsheets.google.com/feeds/cells/' + worksheetId + '/' + sheetId
                    + '/public/basic?alt=json-in-script';

            return function () {
                document.body.className = 'wait loading-data';
                var script = document.createElement('script');
                //noinspection JSUnusedLocalSymbols
                script.onerror = function (event) {
                    document.body.className = 'error'
                };
                document.head.appendChild(script);
                gdata = {
                    io: {
                        handleScriptLoaded: function (json) {
                            var arrayData = gdata.data = [];
                            for (var cellIdx = 0; cellIdx < json.feed.entry.length; cellIdx++) {
                                var cell = json.feed.entry[cellIdx];
                                var coords = /\/R(\d+)C(\d+)$/.exec(cell.id.$t);
                                var row = parseInt(coords[1]) - 1;
                                var column = parseInt(coords[2]) - 1;
                                if (arrayData[row] == null) arrayData[row] = [];
                                arrayData[row][column] = cell.content.$t
                            }
                            var data = [];
                            for (var i = 1; i < arrayData.length; i++) {
                                var oldRow = arrayData[i];
                                var newRow = {};
                                for (var j = 0; j < oldRow.length; j++)
                                    newRow[arrayData[0][j]] = arrayData[i][j];
                                data.push(newRow)
                            }
                            var grid = document.querySelector(gridQuerySelector);
                            grid.columns[0].renderer = function (cell) {
                                var cellText = cell.data;
                                var url = cell.row.data.URLs;
                                if (url != null && url.trim() != '')
                                    cellText = '<a target="userurl" href="' + url + '">' + cellText + '</a>';

                                var type = cell.row.data.Type.trim();
                                switch (type.toLowerCase()) {
                                    case '':
                                    case 'null':
                                        break;

                                    case 'activity park':
                                    case 'adventure park':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-archery', type);
                                        break;
                                    case 'castle':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-city-hall', type);
                                        break;
                                    case 'church':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-church', type);
                                        break;
                                    case 'museum':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-museum', type);
                                        break;
                                    case 'nature':
                                    case 'nature park':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-climbing', type);
                                        break;
                                    case 'spa':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-spa', type);
                                        break;
                                    case 'ship cruise':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-boat-tour', type);
                                        break;
                                    case 'trail':
                                    case 'trails':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-trail-walking', type);
                                        break;
                                    case 'trip':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-route', type);
                                        break;
                                    case 'water park':
                                        cellText += rendererUtils.mapTypeIcon('map-icon-swimming', type);
                                        break;
                                    default:
                                        cellText += '(' + type + ')'
                                }
                                cell.element.innerHTML = cellText


                            };
                            grid.columns[1].renderer = function (cell) {
                                var cellText = cell.data;
                                var url = cell.row.data.Map;
                                if (url != null && url.trim() != '')
                                    cellText = '<a target="userMap" href="' + url + '">' + cellText + '</a>';
                                cell.element.innerHTML = cellText
                            };
                            grid.columns[3].renderer = function (cell) {
                                var cellText = cell.data;
                                var season = cell.row.data.Season;
                                if (season != null)
                                    cellText += '/' + season;
                                cell.element.innerHTML = cellText
                            };
                            grid.columns[4].renderer = function (cell) {
                                var cellText = cell.data;
                                var dist = cell.row.data.Distance;
                                if (dist != '0' && !isNaN(parseInt(dist)))
                                    cellText += ' (' + dist + 'km)';
                                cell.element.innerHTML = cellText
                            };
                            grid.columns[5].renderer = function (cell) {
                                var fee = cell.data.toUpperCase();
                                var html = '';
                                switch (fee) {
                                    case 'P':
                                        html = rendererUtils.vaadinTypeIcon('e60a', 'Paid', 'money');
                                        break;
                                    case 'O':
                                        html = rendererUtils.vaadinTypeIcon('e77e', 'Paid Online', 'money');
                                        break;
                                    default:
                                        html = rendererUtils.vaadinTypeIcon('A0', '', 'money');
                                        break;
                                }
                                html += rendererUtils.renderTransport(cell.row.data.Transport);
                                cell.element.innerHTML = html;
                            };

                            grid.items = data;
                            document.body.className = ''
                        }
                    }

                };
                script.src = sheetUrl
            }
        }
        function showTooltip(elm) {
            if (elm.title != null && elm.title.trim() != "") alert(elm.title); else if (event.srcElement.title != null && event.srcElement.title.trim() != "") alert(elm.title);
        }

        function switchView() {
            var collapseMap = document.querySelector("#collapse-map");
            collapseMap.toggle();
            var mapOpened = collapseMap.opened;
            document.querySelector("#collapse-grid").opened = !mapOpened;
            var map = document.querySelector("#map");
            map.notifyResize();
            map.clear();
            var grid = document.querySelector("#grid");
            if (mapOpened) {
                grid.selection.selected(function(index) {
                    var row = grid.data.source[index];
                    var markerData = /@(-?\d+\.\d*),(-?\d+\.\d*)/.exec(row.Map)
                    if(markerData == null) return;

                    new google.maps.Marker({
                        map: map.map,
                        position: {lat: parseFloat(markerData[1]), lng: parseFloat(markerData[2])},
                        title: row.Name
                    });

/*
                    marker.setAttribute("latitude",60.46+index/20)
                    marker.setAttribute("longitude",22.33-index/20)
                    map.appendChild(marker)
*/
                })
            }
        }
        HTMLImports.whenReady(initSpreadSheet('vaadin-grid', '1JweHWyLI30MkZiGh1xpzDPynE9zehxQ3tuhZukCFzZE', 'od6'))
    </script>

</head>

<body class="wait loading-elements">
<div class="page-header">Turku SightSeeings</div>


<button onclick='switchView()' class="heading">Map/Table</button>
<iron-collapse id='collapse-map'>
    <google-map id='map' latitude='60.46' longitude='22.33'>
    </google-map>
</iron-collapse>
<iron-collapse id='collapse-grid' opened>
    <vaadin-grid selection-mode="multi" id="grid">
        <table>
            <!-- Define the columns -->
            <col name="Name" header-text="Name" sortable="">
            <col name="Description" header-text="Description & Map">
            <col name="Kid_Rate" header-text="Kid rate">
            <col name="Open" header-text="Open">
            <col name="Duration" header-text="Expected duration(Distance)">
            <col name="Fee" header-text="Getting there">
        </table>
    </vaadin-grid>
</iron-collapse>
</body>
</html>
<!DOCTYPE html>
<html lang='en'>
<!--TODO responsive-->
<!--TODO data retrieving element-->
<!--TODO details-->
<!--TODO Clean up the code -->
<!--TODO2 filtering-->
<!--TODO2 season/open hours on map-->
<head>
    <meta charset='UTF-8'>
    <link rel="icon" sizes="16x16" href="Flag_of_turku_Finland.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turku SightSeeings</title>
    <link type='text/css' rel='stylesheet' href='css/loading.css'/>
    <link type='text/css' rel='stylesheet' href='css/styles.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/Vaadin-Icons.css'/>
    <link type='text/css' rel='stylesheet' href='fonts/map-icons.min.css'/>
    <!-- Import Web Components from bower -->
    <script src='bower_components/webcomponentsjs/webcomponents-lite.min.js'></script>
    <link href='bower_components/vaadin-grid/vaadin-grid.html' rel='import'>
    <link href='bower_components/google-map/google-map.html' rel='import'>
    <link href='bower_components/google-map/google-map-marker.html' rel='import'>
    <link href='bower_components/google-map/google-map-directions.html' rel='import'>


    <script onerror='alert(this)'>
        var typeIcons = {
            "activity park": "icons/playground.png",
            "adventure park": "icons/festival.png",
            "castle": "icons/castle-2.png",
            "church": "icons/church-2.png",
            "museum": "icons/museum_archeological.png",
            "nature": "icons/flowers.png",
            "nature park": "icons/hare1.png",
            "ship cruise": "icons/cruiseship.png",
            "spa": "icons/spa.png",
            "trails": "icons/forest.png",
            "trail": "icons/hiking.png",
            "trip": "icons/map.png",
            "water park": "icons/waterpark.png"
        };
        var rendererUtils = {
            mapTypeIcon: function (mapClass, tooltip, additionalClasses) {
                if (additionalClasses == null)  additionalClasses = '';
                return '<span class="icon map-icon ' + mapClass + ' ' + additionalClasses + '" title="' + tooltip + '" onclick="showTooltip(this)"></span>';
            },
            renderTransport: function (transport) {
                if (transport == null) return '';
                transport = transport.toUpperCase().split(',');
                var html = '';
                for (var j = 0; j < transport.length; j++) {
                    if (j > 0) html += ' , ';
                    var k = transport[j];
                    var routeLengthCss = '';
                    var routeLengthPrefix = '';
                    if (k.indexOf('LL') >= 0) {
                        routeLengthPrefix = 'Very Long, ';
                        routeLengthCss = 'transport-long-long';
                    } else if (k.indexOf('L') >= 0) {
                        routeLengthPrefix = 'Long, ';
                        routeLengthCss = 'transport-long';
                    }
                    var trHtml = '';
                    if (k.indexOf('B') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-bicycling', routeLengthPrefix + 'Bike');
                    }
                    if (k.indexOf('C') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-taxi-stand', routeLengthPrefix + 'Car');
                    }
                    if (k.indexOf('W') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-walking', routeLengthPrefix + 'Walk');
                    }
                    if (k.indexOf('Y') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-sailing', routeLengthPrefix + 'Yacht');
                    }
                    if (k.indexOf('S') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-boat-tour', routeLengthPrefix + 'Ship');
                    }
                    if (k.indexOf('F') >= 0) {
                        trHtml += rendererUtils.mapTypeIcon('map-icon-boat-tour', routeLengthPrefix + 'Ferry');
                    }
                    if (routeLengthCss != '')
                        trHtml = '<span class="' + routeLengthCss + '">' + trHtml + '</span>';
                    html += trHtml;
                }
                return html;
            }
        };
        function initSpreadSheet(gridQuerySelector, worksheetId, sheetId) {
            var sheetUrl = 'https://spreadsheets.google.com/feeds/cells/' + worksheetId + '/' + sheetId
                    + '/public/basic?alt=json-in-script';

            return function () {
                document.body.className = 'wait loading-data';
                var script = document.createElement('script');
                //noinspection JSUnusedLocalSymbols
                script.onerror = function (event) {
                    document.body.className = 'error'
                };
                document.head.appendChild(script);
                gdata = {
                    io: {
                        handleScriptLoaded: function (json) {
                            var arrayData = gdata.data = [];
                            for (var cellIdx = 0; cellIdx < json.feed.entry.length; cellIdx++) {
                                var cell = json.feed.entry[cellIdx];
                                var coords = /\/R(\d+)C(\d+)$/.exec(cell.id.$t);
                                var row = parseInt(coords[1]) - 1;
                                var column = parseInt(coords[2]) - 1;
                                if (arrayData[row] == null) arrayData[row] = [];
                                arrayData[row][column] = cell.content.$t
                            }
                            var data = [];
                            for (var i = 1; i < arrayData.length; i++) {
                                var oldRow = arrayData[i];
                                var newRow = {"id": "place" + i};
                                for (var j = 0; j < oldRow.length; j++)
                                    newRow[arrayData[0][j]] = arrayData[i][j];
                                data.push(newRow)
                            }

                            var renderers = {

                                /*
                                 "Open": function (cell) {
                                 var cellText = cell.data;
                                 var season = cell.row.data.Season;
                                 if (season != null)
                                 cellText += '/' + season;
                                 cell.element.innerHTML = cellText
                                 },
                                 */
                                "Duration": function (cell) {
                                    var cellText = cell.data;
                                    var dist = cell.row.data.Distance;
                                    if (dist != '0' && !isNaN(parseInt(dist)))
                                        cellText += ' (' + dist + 'km)';
                                    cell.element.innerHTML = cellText
                                }

                            };
                            var grid = document.querySelector(gridQuerySelector);
                            grid.columns.filter(function (col) {
                                var renderer = renderers[col.name];
                                if (renderer != null) col.renderer = renderer;
                            });

                            grid.items = data;
                            grid.addEventListener("selected-items-changed", function(e) {
                                var map = document.querySelector("google-map");
                                var markers = map.querySelectorAll("google-map-marker");
                                for(var i = 0; i < markers.length;i++) {
                                    markers.item(i).map = null;
                                }
                                grid.selection.selected().filter(function(e) {
                                    var element = map.querySelector("#" + grid.items[e].id);
                                    if(element!=null)element.map = map.map
                                });
                            });
                            grid.addEventListener('sort-order-changed', function() {
                                var colName1 = grid.columns[grid.sortOrder[0].column].name;
                                var colName2;
                                var lesser2;
                                if(grid.sortOrder[1]) {
                                    colName2 = grid.columns[grid.sortOrder[1].column].name;
                                    lesser2 = grid.sortOrder[1].direction == 'asc' ? -1 : 1;
                                }
                                var lesser1 = grid.sortOrder[0].direction == 'asc' ? -1 : 1;
                                data.sort(function(a, b) {
                                    if(a[colName1] == b[colName1] && colName2 != null) {
                                        return (a[colName2] < b[colName2]) ? lesser2 : -lesser2;
                                    }
                                    return (a[colName1] < b[colName1]) ? lesser1 : -lesser1;
                                });
                            });
                            initPage(grid);
                            grid.selection.selectAll();
                        }
                    }

                };
                script.src = sheetUrl
            }
        }

        function showTooltip(elm) {
            if (elm.title != null && elm.title.trim() != "") alert(elm.title); else if (event.srcElement.title != null && event.srcElement.title.trim() != "") alert(elm.title);
        }

        function initPage(grid) {
            document.body.className = '';
            navigator.geolocation.getCurrentPosition(function (position) {
                var $ownPosition = document.querySelector("#own_position");
                $ownPosition.longitude = position.coords.longitude;
                $ownPosition.latitude = position.coords.latitude;
                $ownPosition.removeAttribute("hidden")
            });
            var map = document.querySelector("google-map");
            for (var i = 0; i < grid.items.length; i++) {
                var item = grid.items[i];
                var markerData = /@(-?\d+\.\d*),(-?\d+\.\d*)/.exec(item.Map);
                if (markerData == null) continue;

                var marker = document.createElement("google-map-marker");
                marker.setAttribute("longitude", markerData[2]);
                marker.setAttribute("latitude", markerData[1]);
                marker.setAttribute("title", item.Name);
                marker.setAttribute("id", item.id);
                marker.icon = typeIcons[item.Type.toLowerCase()];
                map.appendChild(marker);
                //marker.map = map.map;
            }


            map.notifyResize();//Workaround

        }
        HTMLImports.whenReady(initSpreadSheet('vaadin-grid', '1JweHWyLI30MkZiGh1xpzDPynE9zehxQ3tuhZukCFzZE', 'od6'))


    </script>

    <template id="details" bind="model">
        <div id="row-details-root">
            <p>
                <span class="details-type" id="Type"></span>:
                <span id="Description"></span>
                <a id="url" target="_blank" class="vaadin-icon">&#xe725;</a>
            </p>

            <p>Good for kids: <span id="Kid_Rate"></span></p>

            <p>Open: <span id="Open"></span></p>

            <p>Duration: <span id="Duration"></span></p>

            <p>Distance, km: <span id="Distance"></span></p>

            <p>Season: <span id="Season"></span></p>

            <p>Fee: <span id="Fee"></span></p>

            <p>Transport: <span id="Transport"></span></p>
        </div>
    </template>

</head>

<body class="wait loading-elements">
<div class="page-header">Turku Sightseeings</div>
<div class="page-content">

    <google-map id="map" latitude="60.18" longitude="21.99" zoom="9">
        <google-map-marker id="own_position" latitude="60.50" longitude="22.34" draggable="false" hidden
                           title="Your position" icon="icons/start-race-2.png"></google-map-marker>

    </google-map>
    <vaadin-grid selection-mode="multi" id="grid">
        <table>
            <!-- Define the columns -->
            <col name="Name" header-text="Name" sortable="">
            <col name="Type" header-text="Description & Map" sortable="">
            <col name="Duration" header-text="Expected duration(Distance)">
        </table>
    </vaadin-grid>
</div>
</body>
</html>